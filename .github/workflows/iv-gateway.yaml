name: iv-gateway

on:
  push:
    branches:
      - develop
      - master
      - feat/*
      - release/*
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Generate proto files
        run: |
          cmake -B build -GNinja
          cmake --build build --target proto_lib

      - name: Run Clang-Format
        run: |
          find src include tests -name '*.cpp' -o -name '*.h' | \
          xargs clang-format --dry-run --Werror

      - name: Run CPP-Check
        run: |
          cppcheck --enable=all \
          --suppress=missingIncludeSystem \
          --inline-suppr \
          --error-exitcode=1 \
          -I build \
          -I src \
          -I include \
          src/ include/

  build-ubuntu-22:
    name: Build on Ubuntu 22.04
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        compiler:
          - { cc: gcc-12, cxx: g++-12 }
          - { cc: clang-14, cxx: clang++-14 }
        build_type: [Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Configure CMake
        env:
          CC: ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --parallel $(nproc)

      - name: Upload build artifacts
        if: matrix.build_type == 'Release' && matrix.compiler.cc == 'gcc-12'
        uses: actions/upload-artifact@v4
        with:
          name: vehicle-gateway-ubuntu-22.04
          path: build/vehicle_gateway
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.build_type }}-${{ matrix.compiler.cc }}
          path: build/Testing/
          retention-days: 7

  build-ubuntu-24:
    name: Build on Ubuntu 24.04
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        build_type: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --parallel $(nproc)

  build-fedora:
    name: Build on Fedora
    runs-on: ubuntu-latest
    container: fedora:42
    strategy:
      matrix:
        build_type: [Release]

    steps:
      - name: Install Git
        run: dnf install -y git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          dnf install -y \
          gcc-c++ \
          cmake \
          ninja-build \
          pkg-config \
          openssl-devel \
          boost-devel \
          zlib-devel \
          grpc-devel \
          grpc-plugins \
          protobuf-devel

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --parallel $(nproc)

      - name: Upload build artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: vehicle-gateway-fedora
          path: build/vehicle_gateway
          retention-days: 7

  sanitizers:
    name: Sanitizers
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        sanitizer: [address, undefined, thread]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Configure CMake
        env:
          CC: clang-14
          CXX: clang++-14
        run: |
          cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_SANITIZERS=ON \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer" \
          -DCMAKE_C_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer" \
          -DBUILD_TESTS=ON \
          -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DBUILD_TESTS=ON \
            -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Generate coverage report
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/third_party/*' '*/tests/*' --output-file coverage.info
          lcov --list coverage.info || echo "No coverage data found - skipping"

      - name: Upload coverage to Codecov
        if: success() || failure()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.info
          fail_ci_if_error: false

  build-arm64-docker:
    name: Build ARM64 Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 Docker image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -f Dockerfile.arm64 \
            --load \
            -t vehicle-gateway:arm64 \
            .

      - name: Verify ARM64 binary
        run: |
          docker run --rm --platform linux/arm64 vehicle-gateway:arm64 --help || true

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            zlib1g-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            protobuf-compiler-grpc \
            protobuf-compiler \
            libboost-system-dev \
            libboost-thread-dev \
            ${{ matrix.compiler.cc }} \
            ${{ matrix.compiler.cxx }}

      - name: Generate proto files
        env:
          CC: clang-14
          CXX: clang++-14
        run: |
          cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBUILD_TESTS=OFF \
          -GNinja
          cmake --build build --target proto_lib

      - name: Run clang-tidy
        run: |
          find src -name '*.cpp' -not -path '*/third_party/*' | \
          xargs clang-tidy-14 -p build --warnings-as-errors='' || true