name: iv-gateway

on:
  push:
    branches: [develop, master, feat/*, release/*]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-ubuntu-24:
    name: Build Ubuntu 24.04 (${{ matrix.compiler.name }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - { name: gcc-12, cc: gcc-12, cxx: g++-12 }
          - { name: gcc-13, cc: gcc-13, cxx: g++-13 }
        build_type: [Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libssl-dev zlib1g-dev \
            libboost-system-dev libboost-thread-dev \
            libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc protobuf-compiler \
            ${{ matrix.compiler.cc }} ${{ matrix.compiler.cxx }}

      - name: Configure
        env:
          CC: ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Upload Artifacts
        if: matrix.compiler.name == 'gcc-13' && matrix.build_type == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: vehicle-gateway-ubuntu-24.04
          path: build/vehicle_gateway
          retention-days: 7

  build-ubuntu-24-clang:
    name: Build Ubuntu 24.04 (Clang)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libssl-dev zlib1g-dev \
            libboost-system-dev libboost-thread-dev \
            libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc protobuf-compiler \
            clang-15 clang++-15 \
            libc++-15-dev libc++abi-15-dev

      - name: Configure
        env:
          CC: clang-15
          CXX: clang++-15
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-stdlib=libc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++" \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

  build-fedora:
    name: Build Fedora 42
    runs-on: ubuntu-latest
    container: fedora:42

    steps:
      - name: Install Git
        run: dnf install -y git

      - name: Fix Git Ownership (Container Issue)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          dnf install -y \
            gcc-c++ cmake ninja-build \
            openssl-devel zlib-devel \
            boost-devel \
            grpc-devel grpc-plugins protobuf-devel

      - name: Configure
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vehicle-gateway-fedora
          path: build/vehicle_gateway
          retention-days: 7

  sanitizers:
    name: Sanitizers (${{ matrix.sanitizer }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libssl-dev zlib1g-dev \
            libboost-system-dev libboost-thread-dev \
            libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc protobuf-compiler \
            clang-15 clang++-15 \
            libc++-15-dev libc++abi-15-dev

      - name: Configure
        env:
          CC: clang-15
          CXX: clang++-15
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -stdlib=libc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }} -stdlib=libc++" \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

  sanitizer-thread:
    name: Sanitizers (thread)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libssl-dev zlib1g-dev \
            libboost-system-dev libboost-thread-dev \
            libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc protobuf-compiler \
            clang-15 clang++-15 \
            libc++-15-dev libc++abi-15-dev

      - name: Create TSan Suppressions
        run: |
          cat > tsan.supp << 'EOF'
          race:std::__1::basic_ios
          race:std::__1::basic_ostream
          race:std::__1::ios_base
          race:libc++.so
          EOF

      - name: Configure
        env:
          CC: clang-15
          CXX: clang++-15
          TSAN_OPTIONS: suppressions=tsan.supp
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -stdlib=libc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread -stdlib=libc++" \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        env:
          TSAN_OPTIONS: suppressions=${{ github.workspace }}/tsan.supp
        run: cd build && ctest --output-on-failure

  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libssl-dev zlib1g-dev \
            libboost-system-dev libboost-thread-dev \
            libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc protobuf-compiler \
            lcov gcovr

      - name: Configure
        run: |
          cmake -B build -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -g -O0" \
            -DCMAKE_C_FLAGS="--coverage -g -O0" \
            -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Generate Coverage (lcov)
        continue-on-error: true
        run: |
          lcov --capture --directory build --output-file coverage.info \
            --rc geninfo_unexecuted_blocks=1 \
            --ignore-errors mismatch,gcov,negative \
            --exclude '/usr/*' \
            --exclude '*/third_party/*' \
            --exclude '*/tests/*' \
            --exclude '*/build/*' || true
          
          if [ -f coverage.info ]; then
            lcov --remove coverage.info '/usr/*' '*/third_party/*' '*/tests/*' '*/build/*' -o coverage.info
            lcov --list coverage.info || true
          fi

      - name: Generate Coverage (gcovr - alternative)
        run: |
          gcovr --xml-pretty --exclude-unreachable-branches \
            --exclude '/usr/*' \
            --exclude '.*/third_party/.*' \
            --exclude '.*/tests/.*' \
            --exclude '.*/build/.*' \
            --root . \
            --output coverage.xml \
            build/ || echo "gcovr failed, continuing..."

      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.info,./coverage.xml
          fail_ci_if_error: false
          verbose: true

  build-arm64-docker:
    name: Build ARM64 Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -f Dockerfile.arm64 \
            --load \
            -t vehicle-gateway:arm64 \
            .

      - name: Verify
        run: |
          docker run --rm --platform linux/arm64 \
            vehicle-gateway:arm64 --help || true